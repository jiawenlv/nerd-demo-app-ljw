{
  "version": "1.0.0",
  "nodes": [
    {
      "id": "668fc6e04eab7bcc9dd976f835a0b384",
      "name": "Start",
      "type": "start",
      "desc": "订单创建流程开始节点，接收用户输入的订单信息",
      "inputs": {
        "UserId": {
          "type": "string",
          "desc": "用户ID",
          "value": "123131231"
        },
        "GoodsId": {
          "type": "string",
          "desc": "商品ID",
          "value": "1"
        },
        "Quantity": {
          "type": "number",
          "desc": "购买数量",
          "value": 4
        }
      },
      "nextNodes": [
        "ValidateInput"
      ]
    },
    {
      "id": "2e7540a3e026c98b21b7db3fe339dc08",
      "name": "StockInsufficientEnd",
      "type": "end",
      "desc": "库存不足结束节点",
      "inputs": {
        "UserId": {
          "type": "string",
          "desc": "用户ID",
          "value": ""
        },
        "GoodsId": {
          "type": "string",
          "desc": "商品ID",
          "value": ""
        },
        "Quantity": {
          "type": "integer",
          "desc": "购买数量",
          "value": ""
        }
      },
      "outputs": {
        "Code": {
          "type": "number",
          "desc": "状态码",
          "value": 400,
          "builtinAttrName": "code",
          "isDynamic": true,
          "isBuiltin": true,
          "editable": true,
          "removable": false
        },
        "Message": {
          "type": "string",
          "desc": "错误信息",
          "value": "库存不足",
          "builtinAttrName": "message",
          "isDynamic": true,
          "isBuiltin": true,
          "editable": true,
          "removable": false
        },
        "Data": {
          "type": "object",
          "desc": "返回数据",
          "value": {},
          "builtinAttrName": "data",
          "isDynamic": true,
          "isBuiltin": true,
          "editable": true,
          "removable": false
        }
      }
    },
    {
      "id": "4679f4c316cc41323d212fd144164bf3",
      "name": "ValidateInput",
      "type": "code",
      "desc": "验证输入参数的有效性",
      "inputs": {
        "UserId": {
          "type": "string",
          "desc": "用户ID",
          "value": "$.Start.inputs.UserId"
        },
        "GoodsId": {
          "type": "string",
          "desc": "商品ID",
          "value": "$.Start.inputs.GoodsId"
        },
        "Quantity": {
          "type": "integer",
          "desc": "购买数量",
          "value": "$.Start.inputs.Quantity"
        }
      },
      "outputs": {
        "ValidatedUserId": {
          "type": "string",
          "desc": "验证通过的用户ID",
          "isDynamic": false,
          "isBuiltin": false,
          "editable": true,
          "removable": true
        },
        "ValidatedGoodsId": {
          "type": "string",
          "desc": "验证通过的商品ID",
          "isDynamic": false,
          "isBuiltin": false,
          "editable": true,
          "removable": true
        },
        "ValidatedQuantity": {
          "type": "integer",
          "desc": "验证通过的购买数量",
          "isDynamic": false,
          "isBuiltin": false,
          "editable": true,
          "removable": true
        }
      },
      "configs": {
        "file": {
          "name": "validateInput2.js"
        },
        "dependencies": []
      },
      "nextNodes": [
        "CheckGoodsStock"
      ]
    },
    {
      "id": "8cad49d3956a84eb0cd9edca1438f2e3",
      "name": "CheckGoodsStock",
      "type": "customSQL",
      "desc": "检查商品库存数量",
      "inputs": {
        "GoodsId": {
          "type": "string",
          "desc": "商品ID",
          "value": "$.ValidateInput.outputs.ValidatedGoodsId"
        }
      },
      "outputs": {
        "StockData": {
          "type": "array",
          "desc": "商品库存数据",
          "builtinAttrName": "data",
          "isDynamic": true,
          "isBuiltin": true,
          "editable": true,
          "removable": false
        }
      },
      "configs": {
        "table": "goods",
        "sql": "SELECT \"stock_quantity\" FROM \"goods\" WHERE \"id\" = '${GoodsId}'"
      },
      "nextNodes": [
        "CheckStockCondition"
      ]
    },
    {
      "id": "49f8aa8c5a76bb1f18203a4eb802e376",
      "name": "CheckStockCondition",
      "type": "condition",
      "desc": "检查库存是否充足",
      "inputs": {
        "StockData": {
          "type": "array",
          "desc": "商品库存数据",
          "value": "$.CheckGoodsStock.outputs.StockData"
        },
        "Quantity": {
          "type": "number",
          "desc": "购买数量",
          "value": "$.ValidateInput.outputs.ValidatedQuantity"
        }
      },
      "configs": {
        "conditionGroups": [
          {
            "conditions": [
              {
                "left": "${StockData[0].stock_quantity}",
                "operator": "greaterThanEqual",
                "right": 4
              }
            ],
            "relationship": "AND",
            "handleId": "9606d2ae744f4109a16287c753bc823e",
            "nextNode": "GetGoodsPrice"
          },
          {
            "conditions": [
              {
                "left": "${StockData[0].stock_quantity}",
                "operator": "lessThan",
                "right": "${Quantity}"
              }
            ],
            "relationship": "AND",
            "handleId": "6b85dd101f3a42cba40f63f3b0bf3a30",
            "isDefaultBranch": true,
            "nextNode": "StockInsufficientEnd"
          }
        ],
        "defaultNextNode": "StockInsufficientEnd"
      }
    },
    {
      "id": "deec958c244212ac4d9200edbab2522f",
      "name": "GetGoodsPrice",
      "type": "customSQL",
      "desc": "获取商品价格信息",
      "inputs": {
        "GoodsId": {
          "type": "string",
          "desc": "商品ID",
          "value": "$.ValidateInput.outputs.ValidatedGoodsId"
        }
      },
      "outputs": {
        "PriceData": {
          "type": "array",
          "desc": "商品价格数据",
          "builtinAttrName": "data",
          "isDynamic": true,
          "isBuiltin": true,
          "editable": true,
          "removable": false
        }
      },
      "configs": {
        "table": "goods",
        "sql": "SELECT \"price\" FROM \"goods\" WHERE \"id\" = '${GoodsId}'"
      },
      "nextNodes": [
        "GenerateOrderNumber"
      ]
    },
    {
      "id": "6c67ca3ec1c06e66da08eb52418223c8",
      "name": "GenerateOrderNumber",
      "type": "code",
      "desc": "生成唯一订单编号",
      "inputs": {
        "UserId": {
          "type": "string",
          "desc": "用户ID",
          "value": "$.ValidateInput.outputs.ValidatedUserId"
        }
      },
      "outputs": {
        "OrderNumber": {
          "type": "string",
          "desc": "生成的订单编号",
          "isDynamic": false,
          "isBuiltin": false,
          "editable": true,
          "removable": true
        }
      },
      "configs": {
        "file": {
          "name": "generateOrderNumber.js"
        },
        "dependencies": []
      },
      "nextNodes": [
        "CalculateOrderAmount"
      ]
    },
    {
      "id": "f92092dbed7033b549b65df8832d170a",
      "name": "CalculateOrderAmount",
      "type": "code",
      "desc": "计算订单总金额",
      "inputs": {
        "PriceData": {
          "type": "array",
          "desc": "商品价格数据",
          "value": "$.GetGoodsPrice.outputs.PriceData"
        },
        "Quantity": {
          "type": "integer",
          "desc": "购买数量",
          "value": "$.ValidateInput.outputs.ValidatedQuantity"
        }
      },
      "outputs": {
        "TotalAmount": {
          "type": "number",
          "desc": "订单总金额",
          "isDynamic": false,
          "isBuiltin": false,
          "editable": true,
          "removable": true
        },
        "UnitPrice": {
          "type": "number",
          "desc": "商品单价",
          "isDynamic": false,
          "isBuiltin": false,
          "editable": true,
          "removable": true
        }
      },
      "configs": {
        "file": {
          "name": "calculateOrderAmount.js"
        },
        "dependencies": []
      },
      "nextNodes": [
        "CreateOrderRecord"
      ]
    },
    {
      "id": "274c7d49e38c32be4353690e79c19764",
      "name": "CreateOrderRecord",
      "type": "customSQL",
      "desc": "创建订单主记录",
      "inputs": {
        "UserId": {
          "type": "string",
          "desc": "用户ID",
          "value": "$.ValidateInput.outputs.ValidatedUserId"
        },
        "OrderNumber": {
          "type": "string",
          "desc": "订单编号",
          "value": "$.GenerateOrderNumber.outputs.OrderNumber"
        },
        "TotalAmount": {
          "type": "number",
          "desc": "订单总金额",
          "value": "$.CalculateOrderAmount.outputs.TotalAmount"
        }
      },
      "outputs": {
        "OrderId": {
          "type": "array",
          "desc": "创建的订单ID",
          "builtinAttrName": "data",
          "isDynamic": true,
          "isBuiltin": true,
          "editable": true,
          "removable": false
        }
      },
      "configs": {
        "table": "order",
        "sql": "INSERT INTO \"order\" (\"user_id\", \"order_number\", \"total_amount\", \"status\", \"created_at\", \"updated_at\") VALUES ('${UserId}', '${OrderNumber}', ${TotalAmount}, 'pending', NOW(), NOW()) RETURNING \"id\""
      },
      "nextNodes": [
        "CreateOrderItem"
      ]
    },
    {
      "id": "5170e65e935113f5c5674b1c83b731a7",
      "name": "CreateOrderItem",
      "type": "customSQL",
      "desc": "创建订单明细项",
      "inputs": {
        "OrderId": {
          "type": "string",
          "desc": "订单ID",
          "value": "$.CreateOrderRecord.outputs.OrderId"
        },
        "GoodsId": {
          "type": "string",
          "desc": "商品ID",
          "value": "$.ValidateInput.outputs.ValidatedGoodsId"
        },
        "Quantity": {
          "type": "integer",
          "desc": "购买数量",
          "value": "$.ValidateInput.outputs.ValidatedQuantity"
        },
        "UnitPrice": {
          "type": "number",
          "desc": "商品单价",
          "value": "$.CalculateOrderAmount.outputs.UnitPrice"
        },
        "Subtotal": {
          "type": "number",
          "desc": "小计金额",
          "value": "$.CalculateOrderAmount.outputs.TotalAmount"
        }
      },
      "outputs": {
        "OrderItemId": {
          "type": "array",
          "desc": "创建的订单项ID",
          "builtinAttrName": "data",
          "isDynamic": true,
          "isBuiltin": true,
          "editable": true,
          "removable": false
        }
      },
      "configs": {
        "table": "order_item",
        "sql": "INSERT INTO \"order_item\" (\"order_id\", \"goods_id\", \"quantity\", \"price_at_purchase\", \"subtotal\", \"created_at\", \"updated_at\") VALUES ('${OrderId}', '${GoodsId}', ${Quantity}, ${UnitPrice}, ${Subtotal}, NOW(), NOW()) RETURNING \"id\""
      },
      "nextNodes": [
        "UpdateGoodsStock"
      ]
    },
    {
      "id": "56366a54022e0b47d52dd987237ae815",
      "name": "UpdateGoodsStock",
      "type": "customSQL",
      "desc": "更新商品库存数量",
      "inputs": {
        "GoodsId": {
          "type": "string",
          "desc": "商品ID",
          "value": "$.ValidateInput.outputs.ValidatedGoodsId"
        },
        "Quantity": {
          "type": "integer",
          "desc": "购买数量",
          "value": "$.ValidateInput.outputs.ValidatedQuantity"
        }
      },
      "outputs": {
        "UpdatedRows": {
          "type": "object",
          "desc": "更新影响的行数",
          "builtinAttrName": "data",
          "isDynamic": true,
          "isBuiltin": true,
          "editable": true,
          "removable": false
        }
      },
      "configs": {
        "table": "goods",
        "sql": "UPDATE \"goods\" SET \"stock_quantity\" = \"stock_quantity\" - ${Quantity}, \"updated_at\" = NOW() WHERE \"id\" = '${GoodsId}'"
      },
      "nextNodes": [
        "SuccessEnd"
      ]
    },
    {
      "id": "6976acb9e6add5822d03fc57faa734fa",
      "name": "SuccessEnd",
      "type": "end",
      "desc": "订单创建成功结束节点",
      "inputs": {
        "OrderId": {
          "type": "string",
          "desc": "订单ID",
          "value": "$.CreateOrderRecord.outputs.OrderId"
        },
        "OrderNumber": {
          "type": "string",
          "desc": "订单编号",
          "value": "$.GenerateOrderNumber.outputs.OrderNumber"
        }
      },
      "outputs": {
        "Code": {
          "type": "number",
          "desc": "状态码",
          "value": 200,
          "builtinAttrName": "code",
          "isDynamic": true,
          "isBuiltin": true,
          "editable": true,
          "removable": false
        },
        "Message": {
          "type": "string",
          "desc": "成功信息",
          "value": "订单创建成功",
          "builtinAttrName": "message",
          "isDynamic": true,
          "isBuiltin": true,
          "editable": true,
          "removable": false
        },
        "Data": {
          "type": "object",
          "desc": "返回数据",
          "value": {
            "orderId": "$.CreateOrderRecord.outputs.OrderId[0].id",
            "orderNumber": "$.GenerateOrderNumber.outputs.OrderNumber"
          },
          "builtinAttrName": "data",
          "isDynamic": true,
          "isBuiltin": true,
          "editable": true,
          "removable": false
        }
      }
    }
  ]
}